<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation Position</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
        }
        .aircraft-info {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .aircraft-count {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .last-update {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        .area-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .telemetry-info {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            font-size: 14px;
        }
        .telemetry-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #d32f2f;
        }
        .aircraft-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transform-origin: center;
        }
        .telemetry-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transform-origin: center;
        }
        .center-button {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .center-button:hover {
            background-color: #b71c1c;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <div class="aircraft-count">Loading data...</div>
        <div class="last-update"></div>
        <div class="area-info"></div>
        <div class="telemetry-info" style="display: none;">
            <div class="telemetry-title"></div>
            <div class="telemetry-position"></div>
            <div class="telemetry-altitude"></div>
            <div class="telemetry-heading"></div>
            <div class="telemetry-speed"></div>
            <div class="telemetry-satellites"></div>
            <div class="telemetry-battery"></div>
            <div class="telemetry-valid"></div>
        </div>
    </div>
    <button class="center-button" id="centerButton" style="display: none;">Centralize</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const initialCoordinates = {
            center: [(-23.607475903452663 + -24.270974395948752) / 2,
                    (-46.48307030043036 + -46.97940265774286) / 2],
            bounds: [
                [-24.270974395948752, -46.97940265774286],
                [-23.607475903452663, -46.48307030043036]
            ]
        };

        const map = L.map('map').fitBounds(initialCoordinates.bounds);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const aircraftMarkers = {};
        const HEADER_SESSION_ID = 'X-Session-ID'
        
        let telemetryMarker = null;
        let debounceTimer;
        let centerOnTelemetry = true;
        let lastTelemetryData = null;
        let sessionId = 0;

        function createAircraftIcon(heading) {
            return L.divIcon({
                className: 'aircraft-marker',
                html: `<svg width="24" height="24" viewBox="0 0 24 24" fill="#3388ff" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(${heading}deg);">
                        <path d="M12,2L4,22h16L12,2z" stroke="#000" stroke-width="1"/>
                      </svg>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        function createTelemetryIcon(heading) {
            return L.divIcon({
                className: 'telemetry-marker',
                html: `<svg width="32" height="32" viewBox="0 0 24 24" fill="#d32f2f" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(${heading}deg);">
                        <path d="M12,2L4,22h16L12,2z" stroke="#000" stroke-width="2"/>
                      </svg>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
        }

        function updateSessionId() {
            fetch('/api/v1/session')
                .then(response => response.text())
                .then(data => {
                    sessionId = data;
                })
                .catch(error => {
                    console.error('Error fetching session ID:', error);
                });
        }

        function updateAircrafts() {
            const bounds = map.getBounds();
            const bbox = {
                min_latitude: bounds.getSouth(),
                min_longitude: bounds.getWest(),
                max_latitude: bounds.getNorth(),
                max_longitude: bounds.getEast()
            };

            document.querySelector('.area-info').textContent =
                `Area: ${bbox.min_latitude.toFixed(4)},${bbox.min_longitude.toFixed(4)} to ${bbox.max_latitude.toFixed(4)},${bbox.max_longitude.toFixed(4)}`;

            fetch('/api/v1/aircraft', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [HEADER_SESSION_ID]: sessionId
                },
                body: JSON.stringify(bbox)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Aircrafts error: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const now = new Date();
                document.querySelector('.last-update').textContent = `Last update: ${now.toLocaleTimeString()}`;

                if (data == null || data.length == 0) {
                    document.querySelector('.aircraft-count').textContent = 'No visible aircrafts';
                    return;
                }

                document.querySelector('.aircraft-count').textContent = `Visible aircrafts: ${data.length}`;
               
                const updatedAircrafts = new Set();
                
                data.forEach(aircraft => {
                    if (!aircraft.latitude || !aircraft.longitude) return;
                    
                    updatedAircrafts.add(aircraft.icao24);
                    
                    if (aircraftMarkers[aircraft.icao24]) {
                        aircraftMarkers[aircraft.icao24].setLatLng([aircraft.latitude, aircraft.longitude]);
                        
                        if (aircraft.true_track !== null) {
                            aircraftMarkers[aircraft.icao24].setIcon(createAircraftIcon(aircraft.true_track));
                        }
                        
                        aircraftMarkers[aircraft.icao24].getPopup().setContent(createPopupContent(aircraft));
                    } else {
                        const marker = L.marker([aircraft.latitude, aircraft.longitude], {
                            icon: createAircraftIcon(aircraft.true_track || 0)
                        }).addTo(map);
                        
                        marker.bindPopup(createPopupContent(aircraft));
                        
                        aircraftMarkers[aircraft.icao24] = marker;
                    }
                });
                
                Object.keys(aircraftMarkers).forEach(icao24 => {
                    if (!updatedAircrafts.has(icao24)) {
                        map.removeLayer(aircraftMarkers[icao24]);
                        delete aircraftMarkers[icao24];
                    }
                });
            })
            .catch(error => {
                document.querySelector('.aircraft-count').textContent = error.message;
            });
        }
        
        function updateTelemetry() {
            fetch('/api/v1/telemetry', {
                headers: {
                    [HEADER_SESSION_ID]: sessionId
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Telemetry error: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.lat || !data.lon) {
                    telemetryMessage("no data");
                    return;
                }
                
                lastTelemetryData = data;
                
                document.querySelector('.telemetry-info').style.display = 'block';
                document.getElementById('centerButton').style.display = 'block';

                document.querySelector('.telemetry-title').textContent = `MAVLink Telemetry Data`;
                document.querySelector('.telemetry-position').textContent = `Position: ${data.lat.toFixed(6)}, ${data.lon.toFixed(6)}`;
                document.querySelector('.telemetry-altitude').textContent = `Altitude: ${data.alt.toFixed(1)} m`;
                document.querySelector('.telemetry-heading').textContent = `Heading: ${data.hdg.toFixed(1)}°`;
                document.querySelector('.telemetry-speed').textContent = `Speed: ${data.spd.toFixed(1)} km/h`;
                document.querySelector('.telemetry-satellites').textContent = `Satellites: ${data.sat}`;
                document.querySelector('.telemetry-battery').textContent = `Battery: ${data.bat.toFixed(1)}V / ${data.rem}%`;
                telemetryMessage("valid");
                
                if (telemetryMarker) {
                    telemetryMarker.setLatLng([data.lat, data.lon]);
                    telemetryMarker.setIcon(createTelemetryIcon(data.hdg));
                } else {
                    telemetryMarker = L.marker([data.lat, data.lon], {icon: createTelemetryIcon(data.hdg)}).addTo(map);
                    telemetryMarker.bindPopup(createTelemetryPopupContent(data));
                }
                
                if (centerOnTelemetry && data.valid) {
                    map.setView([data.lat, data.lon], map.getZoom());
                    centerOnTelemetry = false;
                }
            })
            .catch(error => {
                document.querySelector('.telemetry-title').textContent = error.message;
                telemetryMessage("error fetching telemetry data");
            });
        }

        function createPopupContent(aircraft) {
            return `
                <div class="aircraft-info">
                    <strong>Callsign:</strong> ${aircraft.callsign || 'N/A'}<br>
                    <strong>ICAO24:</strong> ${aircraft.icao24}<br>
                    <strong>Country Origin:</strong> ${aircraft.origin_country}<br>
                    <strong>Altitude:</strong> ${aircraft.baro_altitude ? Math.round(aircraft.baro_altitude) + ' m' : 'N/A'}<br>
                    <strong>Speed:</strong> ${aircraft.velocity ? Math.round(aircraft.velocity * 3.6) + ' km/h' : 'N/A'}<br>
                    <strong>Heading:</strong> ${aircraft.true_track ? Math.round(aircraft.true_track) + '°' : 'N/A'}<br>
                    <strong>On Ground:</strong> ${aircraft.on_ground ? 'Yes' : 'No'}
                </div>
            `;
        }
        
        function createTelemetryPopupContent(telemetry) {
            return `
                <div class="aircraft-info">
                    <strong style="color: #d32f2f;">MAVLinkTelemetry</strong><br>
                    <strong>Latitude:</strong> ${telemetry.lat.toFixed(6)}<br>
                    <strong>Longitude:</strong> ${telemetry.lon.toFixed(6)}<br>
                    <strong>Altitude:</strong> ${telemetry.alt.toFixed(1)} m<br>
                    <strong>Speed:</strong> ${telemetry.spd.toFixed(1)} km/h<br>
                    <strong>Heading:</strong> ${telemetry.hdg.toFixed(1)}°<br>
                    <strong>Satelites:</strong> ${telemetry.sat}<br>
                    <strong>Battery:</strong> ${telemetry.bat.toFixed(1)}V / ${telemetry.rem}%<br>
                    <strong>Current:</strong> ${telemetry.cur.toFixed(2)}A<br>
                    <strong>Consumption:</strong> ${telemetry.mah}mAh
                </div>
            `;
        }

        function telemetryMessage(message) {
            document.querySelector('.telemetry-valid').textContent = `Message: ${message}`;
        }

        function debouncedUpdateAircraftData() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateAircrafts, 500);
        }

        map.on('moveend', debouncedUpdateAircraftData);
        map.on('zoomend', debouncedUpdateAircraftData);
        
        document.getElementById('centerButton').addEventListener('click', function() {
            if (lastTelemetryData && lastTelemetryData.lat && lastTelemetryData.lon) {
                map.setView([lastTelemetryData.lat, lastTelemetryData.lon], map.getZoom());
            }
        });
        
        setTimeout(() => {
            updateTelemetry();
            setInterval(updateTelemetry, 1000);
        }, 1000)

        setTimeout(() => {
            updateAircrafts();
            setInterval(updateAircrafts, 30000);
        }, 5000)

        updateSessionId();
    </script>
</body>
</html>
